format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  lint:
    steps:
    - change-workdir@1:
        inputs:
        - path: $STEP_DIR
    - script:
        title: YAML lint
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex

            if [[ "$OSTYPE" == "linux-gnu"* ]]; then
                # pipx is only available in OS repos from Ubuntu 23+, so we need to install via pip for now
                ubuntu_version=$(lsb_release -rs)
                if [[ $ubuntu_version == "20.04" ]]; then
                    apt-get remove -y yamllint
                    # Default Python version is the system-wide and it doesn't have venv (which is needed for pipx)
                    apt-get update
                    yes | apt-get install python3.8-venv
                    # Ubuntu 20 ships with an old pip that doesn't recognize the --break-system-packages flag
                    pip install pipx
                else
                    pip install --user --break-system-packages pipx
                fi
                export PATH="$PATH:/root/.local/bin"
                pipx ensurepath
                source ~/.bashrc # reload $PATH changes
            else
                HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1 brew install pipx
                export PATH="$PATH:$HOME/.local/bin"
                pipx ensurepath
                source ~/.bashrc # reload $PATH changes
            fi

            pipx install yamllint
            yamllint --format colored . # Config file is implicitly set via $YAMLLINT_CONFIG_FILE
    - script@1:
        title: Audit step
        run_if: "{{enveq \"SKIP_STEP_YML_VALIDATION\" \"false\"}}"
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            pwd

            stepman audit --step-yml ./step.yml
    - git::https://github.com/bitrise-steplib/steps-validate-json-schema.git@main:
        title: Validate JSON schema
        run_if: "{{enveq \"SKIP_STEP_YML_VALIDATION\" \"false\"}}"
        inputs:
        - schema_url: https://raw.githubusercontent.com/bitrise-io/bitrise-json-schemas/main/step.schema.json
        - yaml_path: ./step.yml
        - warning_patterns: |-
            I\[#\] S\[#/additionalProperties\] additionalProperties .+ not allowed
            I\[#\] S\[#/required\] missing properties: .+
            I\[#/summary\] S\[#/properties/summary/pattern\] does not match pattern "\^\.\{1,100\}\$"
            I\[#/deps/(brew|apt_get)+/\d+/(name|bin_name)+\] S\[#/definitions/(BrewDepModel|AptGetDepModel)+/properties/(name|bin_name)+/not\] not failed
            I\[#/(inputs|outputs)+/\d+/opts\] S\[#/definitions/EnvVarOpts/required\] missing properties: "summary"
            I\[#/(inputs|outputs)+/\d+/opts/summary\] S\[#/definitions/EnvVarOpts/properties/summary/minLength\] length must be >= 1, but got 0
            I\[#/inputs/\d+/.+\] S\[#/definitions/InputEnvVar/additionalProperties/type\] expected .+, but got .+
            I\[#/inputs/\d+/opts/value_options\] S\[#/definitions/EnvVarOpts/properties/value_options/minItems\] minimum 2 items allowed, but found \d+ items
    - script@1:
        title: Run golangci-lint
        run_if: "{{enveq \"SKIP_GO_CHECKS\" \"false\"}}"
        is_always_run: true
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- v1.64.8
            ./bin/golangci-lint run --timeout 5m --color always

  unit_test:
    steps:
    - change-workdir@1:
        inputs:
        - path: $STEP_DIR
    - go-list: { }
    - go-test: { }

  ai_pr_summary:
    # Set status_report_name to report the status of this workflow separately.
    status_report_name: 'AI Review'
    # Simple Medium Linux machine is enough
    meta:
        bitrise.io:
            machine_type_id: g2.linux.medium
            stack: linux-docker-android-22.04
    envs:
        - GITHUB_TOKEN: $AI_GITHUB_TOKEN
        - LITELLM_API_KEY: $LITELLM_API_KEY
        - PUBSUB_TOPIC_ID: bitcode-analytics
        - PUBSUB_PROJECT_ID: ip-ai-dev
        - PUBSUB_CREDENTIALS_JSON_B64: $AI_PUBSUB_CREDENTIALS_JSON_B64
    steps:
        - script@1.2.1:
            title: Generate AI Review for PR
            inputs:
              - content: |-
                    #!/bin/bash
                    set -e
                    
                    sudo apt update
                    sudo apt install ripgrep -y
                    
                    # Parse repository name from repo URL (works for SSH & HTTPS)
                    REPO_URL="${GIT_REPOSITORY_URL}"
                    REPO=$(echo "$REPO_URL" | sed -E 's#(git@|https://)([^/:]+)[/:]([^/]+)/([^.]+)(\.git)?#\3/\4#')
                    
                    # 1. Unshallow the repo if it's a shallow clone (safe to run even if already full)
                    git fetch --unshallow || true
                    
                    # 2. Fetch all branch refs (this ensures both the PR and the target/destination branch are present)
                    git fetch origin
                    
                    # 3. Fetch both relevant branches explicitly for safety (redundant but safe)
                    git fetch origin "$BITRISEIO_GIT_BRANCH_DEST"
                    git fetch origin "$BITRISE_GIT_BRANCH"
                    
                    # 4. Create/reset local branches to match the remote
                    git checkout -B "$BITRISEIO_GIT_BRANCH_DEST" "origin/$BITRISEIO_GIT_BRANCH_DEST"
                    git checkout -B "$BITRISE_GIT_BRANCH" "origin/$BITRISE_GIT_BRANCH"
                    
                    # (Optionally: check out the PR branch if that is the branch you want to analyze)
                    git checkout "$BITRISE_GIT_BRANCH"
                    
                    # Download and install bitcode
                    curl -L https://storage.googleapis.com/bitrise-bitcode/bitcode-linux-amd64.tar.gz -o /tmp/bitcode-linux-amd64.tar.gz
                    sudo tar -xzf /tmp/bitcode-linux-amd64.tar.gz -C /usr/local/bin/
                    sudo chmod +x /usr/local/bin/bitcode
                    
                    # 6. Run your AI reviewer (customize flags as needed)
                    bitcode review  \
                      --git-provider github \
                      --pr-id="${BITRISE_PULL_REQUEST}" \
                      --repo="${REPO}" \
                      --max-token-usage 5000000 \
                      --session-id "${BITRISE_BUILD_SLUG}" \
                      --log-level info
                    
                    echo "Done! PR reviewed."
